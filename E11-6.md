# デジタル通信方式 I2C

*Ref: 教科書 pp.42*

## I2C通信

I2C は、IC 間で通信をするために開発された、デジタル通信方式である。Arduino でも I2C 通信を用いて電子部品の制御ができる。I2C の概要と Arudino で I2C を利用するための手順について説明する。

### I2C通信の仕組み

I2C通信は、**マスター**と呼ばれるデバイスと**スレーブ**と呼ばれるデバイス間で行われる通信である。マスターは、通信を制御する役割を持ち、スレーブはマスターからの指示に従ってデータを送受信する。

通信には、**SDA**（シリアルデータ）と**SCL**（シリアルクロック）の2本の信号線が使われる。

* **SDA:** データを送受信するための信号線
* **SCL:** 通信のタイミングを制御するためのクロック信号

マスターはSCL信号を生成し、スレーブはこの信号に同期して通信を行う。

### I2C通信の特徴

I2C通信には、以下のような特徴がある：

* **2線式:** SDAとSCLの2本の信号線だけで通信できるため、必要な配線が少なくて済む。
* **マルチマスタ:** 複数のマスターデバイスが同じバス上で通信することができる。
* **アドレス指定:** 各スレーブデバイスには固有のアドレスが割り当てられており、マスターはこのアドレスを使って特定のデバイスと通信することができる。
* **双方向通信:** マスターとスレーブの間で双方向にデータを送受信することができる。
* **オープンコレクタ:** SDAとSCL信号はオープンコレクタ出力であり、プルアップ抵抗が必要となる。

### I2C通信の動作

I2C通信では、以下の基本的な動作が行われる：

1. **マスターデバイスは、バスをアイドル状態にする。**
2. **マスターデバイスは、スタートコンディションを生成する。** これは、SCL信号をHレベルからLレベルに遷移させることで行われる。
3. **マスターデバイスは、スレーブデバイスのアドレスを送信する。** アドレスには、通信対象となるスレーブデバイスのアドレスと、読み書きの方向（リード/ライト）が含まれる。
4. **アドレス指定されたスレーブデバイスは、ACK（Acknowledge）を送信する。** これは、SCL信号をLレベルからHレベルに遷移させることで行われる。
5. **マスターデバイスとスレーブデバイス間でデータの送受信が行われる。** データは、8ビット単位で送受信される。
6. **マスターデバイスは、ストップコンディションを生成する。** これは、SCL信号をLレベルからHレベルに遷移させ、その後Hレベルを維持することで行われる。

### I2C通信の利点と欠点

**利点:**

* 必要な配線が少なく、シンプルに接続できる
* 複数のデバイスを同じバス上で接続できる
* 低コストで実装できる
* 省電力

**欠点:**

* 通信速度が遅い
* ノイズの影響を受けやすい
* 長距離通信には向かない

### I2C通信の応用例

I2C通信は、様々な機器の接続に使用されている。以下は、代表的な例である。

* **マイコンとセンサーの接続:** 温度センサー、湿度センサー、加速度センサーなどのセンサーをマイコンに接続して、センサデータを取得することができる。
* **マイコンとモーターの接続:** サーボモーター、ステッピングモーターなどのモーターをマイコンに接続して、モーターを制御することができる。
* **マイコンとメモリの接続:** EEPROM、フラッシュメモリなどのメモリをマイコンに接続して、データを保存することができる。
* **マイコンとリアルタイムクロックの接続:** RTC（Real Time Clock）をマイコンに接続して、システム時刻を取得することができる。

# Arudino で I2C デバイスを使う

Arduino で I2C デバイスと通信するには Wire ライブラリ (Python のモジュールみたいなもの) を使う。

I2C 通信を利用する温度センサーモジュール ADT7410 がある。I2C を使ってこのセンサーモジュールから温度を読み取るプログラムは以下のようになる：

- **(A) の行について**  
    data[0] は上位の 8bit (1byte) である。data[1] は下位の 8bit (1byte) である。<< という演算子 (記号) は data[0] を左に 8bit ずらしなさい (これをシフト演算という) という意味である。  
    data[0] が 1000_0101 だったら、左に 8 個ずらし空いたところには 0 を入れるので、1000_0101_0000_0000 の 16 ケタの 2 進数になる。  
    | は OR 演算を意味している。data[1] が 1010_1100 だったら、先程あけた 8 個分の 0 のところにピッタリおさまるので、結果は 1000_0101_1010_1100 になる。  
    つまり data[0] を 8 ケタずらして、data[1] と連結している。


```c++
#include <Wire.h> // I2Cライブラリのインクルード

const int address = 0x48; // ADT7410のアドレス

void setup() {
  Serial.begin(9600); // シリアル通信の開始
  Wire.begin(); // I2C通信の開始
}

void loop() {
  // 温度データの読み取り
  byte data[2];
  Wire.requestFrom(address, 2);
  data[0] = Wire.read();
  data[1] = Wire.read();

  // 温度データの変換
  int rawTemperature = (data[0] << 8) | data[1]; // (A)
  float temperature = rawTemperature * 0.125; // 温度データの変換

  // 温度の表示
  Serial.print("Temperature: ");
  Serial.print(temperature);
  Serial.println("°C");

  delay(1000); // 1秒間隔で読み取り
}
```

**プログラムの説明**

1. `#include <Wire.h>`: I2Cライブラリのインクルード
2. `const int address = 0x48;`: ADT7410のアドレス定義
3. `void setup()`:
    * `Serial.begin(9600);`: シリアル通信の開始（ボーレート9600bps）
    * `Wire.begin();`: I2C通信の開始
4. `void loop()`:
    * `byte data[2];`: 温度データ格納用の配列
    * `Wire.requestFrom(address, 2);`: ADT7410から2バイトのデータを読み取る
    * `data[0] = Wire.read();`: 読み取ったデータを配列に格納
    * `data[1] = Wire.read();`: 読み取ったデータを配列に格納
    * `int rawTemperature = (data[0] << 8) | data[1];`: 読み取ったデータを16ビット整数に変換
    * `float temperature = rawTemperature * 0.125;`: 温度データの変換（0.125倍して摂氏温度に変換）
    * `Serial.print("Temperature: ");`: シリアルモニターに「Temperature: 」と出力
    * `Serial.print(temperature);`: シリアルモニターに温度値を出力
    * `Serial.println("°C");`: シリアルモニターに「°C」と出力
    * `delay(1000);`: 次回の読み取りまで1秒間待つ

# I2C Scanner の使い方

**I2C Scanner** はいまどんな I2C デバイスが Arduino に接続されているかを表示するプログラムである。スキャン結果をシリアルモニタに出力することで、接続されているデバイスのアドレスを確認することができる。

### I2C Scannerの使い方

1. 以下のスケッチコードをArduino IDEのスケッチエディタに貼り付ける。

```c++
/*
 * I2C Scanner
 *
 * このスケッチは、I2Cバスに接続されているデバイスをスキャンします。
 * スキャン結果をシリアルモニタに出力します。
 *
 * Author: unknown
 */

#include <Wire.h>

void setup() {
  Serial.begin(9600); // シリアル通信の開始
  Serial.println("I2C Scanner");

  byte numberOfDevices = 0;

  for (byte address = 1; address < 128; address++) {
    // デバイスに接続を試みます
    Wire.beginTransmission(address);
    int error = Wire.endTransmission();

    // デバイスに接続できた場合、アドレスとデバイス名をシリアルモニタに出力します
    if (error == 0) {
      Serial.print("I2C device found at address 0x");
      Serial.print(address, HEX);
      Serial.println("");
      numberOfDevices++;
    }
  }

  Serial.println("--------");
  Serial.print("Scanned ");
  Serial.print(numberOfDevices);
  Serial.println(" devices.");
}

void loop() {
}
```

3. **スケッチをArduinoボードに書き込む。**
4. **Arduino IDEのシリアルモニタを開く。**
5. シリアルモニタに、I2Cバスに接続されているデバイスのアドレスが表示される。

**例**

```
I2C Scanner
I2C device found at address 0x08
I2C device found at address 0x27
--------
Scanned 2 devices.
```

この例では、I2Cバスにアドレス0x08と0x27のデバイスが接続されている。

### I2C Scannerの応用例

* I2Cバスに接続されているデバイスをデバッグする
* 新しいデバイスを接続したときに、アドレスを確認する
* I2Cバスのトラブルシューティングを行う
